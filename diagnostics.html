<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnostika Chat Logger</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f0f2f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2159A0;
      border-bottom: 3px solid #2159A0;
      padding-bottom: 10px;
    }
    .status {
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-weight: bold;
    }
    .loading { background: #fff3cd; color: #856404; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      border-left: 4px solid #2159A0;
    }
    button {
      background: #2159A0;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover { background: #1B4B87; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .step {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      border-left: 4px solid #2159A0;
    }
    .step h3 { margin-top: 0; color: #2159A0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Diagnostika Chat Logger API</h1>
    
    <div class="info" style="margin-bottom: 20px;">
      Tento n√°stroj v√°m pom√¥≈æe identifikova≈• probl√©m s ukladan√≠m chatov.
    </div>

    <button onclick="runDiagnostics()">‚ñ∂Ô∏è Spusti≈• diagnostiku</button>
    <button onclick="testAPI()">üß™ Test API volania</button>
    
    <div id="results"></div>
  </div>

  <script>
    const API_ENDPOINT = 'https://fifuk-chatbot.vercel.app/api/saveChat';
    const resultsDiv = document.getElementById('results');

    async function runDiagnostics() {
      resultsDiv.innerHTML = '<div class="status loading">‚è≥ Sp√∫≈°≈•am diagnostiku...</div>';
      
      let html = '<h2>üìä V√Ωsledky diagnostiky</h2>';
      
      // Step 1: Check endpoint accessibility
      html += '<div class="step">';
      html += '<h3>1Ô∏è‚É£ Kontrola dostupnosti API endpointu</h3>';
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'OPTIONS'
        });
        html += `<div class="status success">‚úÖ Endpoint je dostupn√Ω (Status: ${response.status})</div>`;
      } catch (error) {
        html += `<div class="status error">‚ùå Endpoint nie je dostupn√Ω: ${error.message}</div>`;
        html += '<p><strong>Rie≈°enie:</strong> Skontrolujte, ƒçi je projekt nasaden√Ω na Vercel.</p>';
      }
      html += '</div>';

      // Step 2: Test with minimal data
      html += '<div class="step">';
      html += '<h3>2Ô∏è‚É£ Test s minim√°lnymi d√°tami</h3>';
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userMessage: 'Test',
            botResponse: 'Test response',
            website: 'test.com'
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          html += '<div class="status success">‚úÖ API endpoint funguje spr√°vne!</div>';
          html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        } else {
          html += `<div class="status error">‚ùå API vr√°tilo chybu (${response.status})</div>`;
          html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
          
          // Provide specific solutions
          html += '<h4>üîß Mo≈æn√© rie≈°enia:</h4><ul>';
          
          if (data.details && data.details.includes('SUPABASE')) {
            html += '<li><strong>Ch√Ωbaj√∫ environment variables v Vercel:</strong><br>';
            html += '‚Üí Choƒète do Vercel Dashboard ‚Üí Project ‚Üí Settings ‚Üí Environment Variables<br>';
            html += '‚Üí Pridajte: <code>SUPABASE_URL</code> a <code>SUPABASE_KEY</code></li>';
          }
          
          if (data.details && data.details.includes('table')) {
            html += '<li><strong>Tabuƒæka neexistuje alebo m√° zl√© stƒ∫pce:</strong><br>';
            html += '‚Üí Skontrolujte, ƒçi tabuƒæka <code>chat_logs</code> existuje v Supabase<br>';
            html += '‚Üí Mus√≠ ma≈• stƒ∫pce: <code>user_message</code>, <code>bot_response</code>, <code>website</code>, <code>created_at</code></li>';
          }
          
          if (data.details && data.details.includes('permission')) {
            html += '<li><strong>Probl√©m s opr√°vneniami:</strong><br>';
            html += '‚Üí Skontrolujte RLS (Row Level Security) policies v Supabase<br>';
            html += '‚Üí Uistite sa, ≈æe politika povoƒæuje INSERT oper√°cie</li>';
          }
          
          html += '</ul>';
        }
      } catch (error) {
        html += `<div class="status error">‚ùå Chyba pri volan√≠ API: ${error.message}</div>`;
      }
      html += '</div>';

      // Step 3: Check current environment
      html += '<div class="step">';
      html += '<h3>3Ô∏è‚É£ Inform√°cie o prostred√≠</h3>';
      html += '<pre>';
      html += 'Current URL: ' + window.location.href + '\n';
      html += 'Hostname: ' + window.location.hostname + '\n';
      html += 'API Endpoint: ' + API_ENDPOINT + '\n';
      html += 'Browser: ' + navigator.userAgent;
      html += '</pre>';
      html += '</div>';

      // Step 4: Recommendations
      html += '<div class="step">';
      html += '<h3>4Ô∏è‚É£ Kontroln√Ω zoznam</h3>';
      html += '<ul style="line-height: 1.8;">';
      html += '<li>‚òëÔ∏è Je projekt nasaden√Ω na Vercel?</li>';
      html += '<li>‚òëÔ∏è S√∫ nastaven√© <code>SUPABASE_URL</code> a <code>SUPABASE_KEY</code> v Vercel?</li>';
      html += '<li>‚òëÔ∏è Existuje tabuƒæka <code>chat_logs</code> v Supabase?</li>';
      html += '<li>‚òëÔ∏è M√° tabuƒæka spr√°vne stƒ∫pce (user_message, bot_response, website, created_at)?</li>';
      html += '<li>‚òëÔ∏è S√∫ nastaven√© RLS policies pre INSERT?</li>';
      html += '<li>‚òëÔ∏è Je <code>@supabase/supabase-js</code> nain≈°talovan√Ω? (spustite <code>npm install</code>)</li>';
      html += '</ul>';
      html += '</div>';

      resultsDiv.innerHTML = html;
    }

    async function testAPI() {
      resultsDiv.innerHTML = '<div class="status loading">‚è≥ Testujem API...</div>';
      
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userMessage: 'Diagnostick√Ω test: ' + new Date().toISOString(),
            botResponse: 'Toto je testovacia odpoveƒè od bota.',
            website: window.location.hostname
          })
        });

        const data = await response.json();
        
        let html = '<h2>üß™ V√Ωsledok testu API</h2>';
        html += `<div class="status ${response.ok ? 'success' : 'error'}">`;
        html += `${response.ok ? '‚úÖ' : '‚ùå'} Status: ${response.status}`;
        html += '</div>';
        
        html += '<h3>üì§ Odoslan√° po≈æiadavka:</h3>';
        html += '<pre>' + JSON.stringify({
          userMessage: 'Diagnostick√Ω test: ' + new Date().toISOString(),
          botResponse: 'Toto je testovacia odpoveƒè od bota.',
          website: window.location.hostname
        }, null, 2) + '</pre>';
        
        html += '<h3>üì• Odpoveƒè servera:</h3>';
        html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        
        if (!response.ok) {
          html += '<div class="status error">';
          html += '<h4>‚ùå Chyba detekovan√°</h4>';
          html += '<p><strong>Detaily:</strong> ' + (data.details || data.error || 'Nezn√°ma chyba') + '</p>';
          
          if (data.hint) {
            html += '<p><strong>N√°poveda:</strong> ' + data.hint + '</p>';
          }
          
          html += '<h4>üîß Kroky na opravu:</h4>';
          html += '<ol>';
          html += '<li>Otvorte Vercel Dashboard</li>';
          html += '<li>Choƒète do Settings ‚Üí Environment Variables</li>';
          html += '<li>Skontrolujte, ƒçi existuj√∫ <code>SUPABASE_URL</code> a <code>SUPABASE_KEY</code></li>';
          html += '<li>Otvorte Supabase Dashboard ‚Üí Table Editor</li>';
          html += '<li>Skontrolujte, ƒçi existuje tabuƒæka <code>chat_logs</code></li>';
          html += '<li>Skontrolujte RLS policies (Authentication ‚Üí Policies)</li>';
          html += '</ol>';
          html += '</div>';
        } else {
          html += '<div class="status success">';
          html += '<h4>‚úÖ √öspech!</h4>';
          html += '<p>API funguje spr√°vne. Chat bol √∫spe≈°ne ulo≈æen√Ω do datab√°zy.</p>';
          html += '<p>M√¥≈æete overi≈• v Supabase Dashboard ‚Üí Table Editor ‚Üí chat_logs</p>';
          html += '</div>';
        }
        
        resultsDiv.innerHTML = html;
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="status error">
            <h3>‚ùå Chyba siete</h3>
            <p>${error.message}</p>
            <p>Mo≈æn√© pr√≠ƒçiny:</p>
            <ul>
              <li>API endpoint neexistuje alebo nie je dostupn√Ω</li>
              <li>CORS probl√©m</li>
              <li>Projekt nie je nasaden√Ω na Vercel</li>
            </ul>
          </div>
        `;
      }
    }
  </script>
</body>
</html>
